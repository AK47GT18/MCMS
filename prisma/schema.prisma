generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                       Int                   @id @default(autoincrement())
  name                     String                @db.VarChar(100)
  email                    String                @unique @db.VarChar(255)
  phone                    String?               @db.VarChar(20)
  role                     RoleEnum
  avatarUrl                String?               @map("avatar_url")
  permissions              String[]
  passwordHash             String?               @map("password_hash") @db.VarChar(255)
  lastLoginIp              String?               @map("last_login_ip") @db.Inet
  isLocked                 Boolean               @default(false) @map("is_locked")
  createdAt                DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt                DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  passwordResetExpires     DateTime?             @map("password_reset_expires") @db.Timestamptz(6)
  passwordResetToken       String?               @map("password_reset_token") @db.VarChar(100)
  statusReason             String?               @map("status_reason")
  mustChangeEmail          Boolean               @default(false) @map("must_change_email")
  mustChangePassword       Boolean               @default(false) @map("must_change_password")
  assetLogs                AssetLog[]
  auditLogs                AuditLog[]
  budgetChangeRequests     BudgetChangeRequest[]
  dailyLogs                DailyLog[]
  issuesAssigned           Issue[]               @relation("AssignedTo")
  issuesReported           Issue[]               @relation("ReportedBy")
  procurementRequests      ProcurementRequest[]
  managedProjects          Project[]             @relation("ProjectManager")
  requisitionsReviewed     Requisition[]         @relation("RequisitionsReviewed")
  requisitionsSubmitted    Requisition[]         @relation("RequisitionsSubmitted")
  transactions             Transaction[]
  safetyIncidents          SafetyIncident[]
  whistleblowerAssigned    WhistleblowerReport[] @relation("AssignedTo")
  whistleblowerReported    WhistleblowerReport[] @relation("Reporter")
  uploadedDocuments        Document[]            @relation("DocumentUploader")
  uploadedDocumentVersions DocumentVersion[]     @relation("DocumentVersionUploader")

  @@map("users")
}

model Project {
  id                   Int                   @id @default(autoincrement())
  code                 String                @unique @db.VarChar(20)
  name                 String                @db.VarChar(255)
  managerId            Int?                  @map("manager_id")
  projectType          ProjectTypeEnum?      @map("project_type")
  status               String                @default("planning") @db.VarChar(20)
  suspensionReason     String?               @map("suspension_reason")
  contractValue        Decimal?              @map("contract_value") @db.Decimal(18, 2)
  budgetTotal          Decimal?              @map("budget_total") @db.Decimal(18, 2)
  budgetSpent          Decimal?              @default(0) @map("budget_spent") @db.Decimal(18, 2)
  startDate            DateTime?             @map("start_date") @db.Date
  endDate              DateTime?             @map("end_date") @db.Date
  createdAt            DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt            DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  client               String?               @db.VarChar(255)
  lat                  Decimal?              @db.Decimal(10, 8)
  lng                  Decimal?              @db.Decimal(11, 8)
  radius               Int?                  @default(500)
  assetLogs            AssetLog[]
  assets               Asset[]
  budgetChangeRequests BudgetChangeRequest[]
  contracts            Contract[]
  dailyLogs            DailyLog[]
  documents            Document[]
  issues               Issue[]
  manager              User?                 @relation("ProjectManager", fields: [managerId], references: [id])
  requisitions         Requisition[]
  safetyIncidents      SafetyIncident[]
  tasks                Task[]
  transactions         Transaction[]
  whistleblowerReports WhistleblowerReport[]

  @@map("projects")
}

model Task {
  id           Int        @id @default(autoincrement())
  projectId    Int        @map("project_id")
  name         String     @db.VarChar(255)
  startDate    DateTime   @map("start_date") @db.Date
  endDate      DateTime   @map("end_date") @db.Date
  progress     Int        @default(0) @db.SmallInt
  dependencyId Int?       @map("dependency_id")
  statusClass  String?    @map("status_class") @db.VarChar(50)
  createdAt    DateTime   @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt    DateTime   @updatedAt @map("updated_at") @db.Timestamptz(6)
  daily_logs   DailyLog[]
  dependency   Task?      @relation("TaskDependency", fields: [dependencyId], references: [id])
  dependents   Task[]     @relation("TaskDependency")
  project      Project    @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@index([projectId])
  @@index([startDate, endDate])
  @@map("tasks")
}

model Contract {
  id          Int                @id @default(autoincrement())
  refCode     String             @unique @map("ref_code") @db.VarChar(30)
  projectId   Int?               @map("project_id")
  vendorName  String?            @map("vendor_name") @db.VarChar(255)
  title       String             @db.VarChar(255)
  value       Decimal?           @db.Decimal(18, 2)
  startDate   DateTime?          @map("start_date") @db.Date
  endDate     DateTime?          @map("end_date") @db.Date
  status      ContractStatusEnum @default(draft)
  documentUrl String?            @map("document_url")
  createdAt   DateTime           @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt   DateTime           @updatedAt @map("updated_at") @db.Timestamptz(6)
  project     Project?           @relation(fields: [projectId], references: [id])
  milestones  Milestone[]

  @@index([projectId])
  @@map("contracts")
}

model Milestone {
  id             Int                 @id @default(autoincrement())
  contractId     Int                 @map("contract_id")
  refCode        String?             @map("ref_code") @db.VarChar(20)
  description    String?             @db.VarChar(255)
  dueDate        DateTime?           @map("due_date") @db.Date
  value          Decimal?            @db.Decimal(18, 2)
  status         MilestoneStatusEnum @default(scheduled)
  certificateUrl String?             @map("certificate_url")
  createdAt      DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt      DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  contract       Contract            @relation(fields: [contractId], references: [id], onDelete: Cascade)

  @@map("milestones")
}

model Asset {
  id                 Int                 @id @default(autoincrement())
  assetCode          String              @unique @map("asset_code") @db.VarChar(20)
  name               String              @db.VarChar(255)
  serialNumber       String?             @map("serial_number") @db.VarChar(100)
  category           String?             @db.VarChar(50)
  modelYear          Int?                @map("model_year") @db.SmallInt
  hoursOrKm          Int?                @map("hours_or_km")
  condition          AssetConditionEnum  @default(Good)
  fuelLevel          Int?                @map("fuel_level") @db.SmallInt
  currentProjectId   Int?                @map("current_project_id")
  status             AssetStatusEnum     @default(available)
  estimatedValue     Decimal?            @map("estimated_value") @db.Decimal(18, 2)
  lastMaintenanceAt  DateTime?           @map("last_maintenance_at") @db.Date
  createdAt          DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt          DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  assetLogs          AssetLog[]
  currentProject     Project?            @relation(fields: [currentProjectId], references: [id])
  maintenanceRecords MaintenanceRecord[]

  @@index([currentProjectId])
  @@index([status])
  @@map("assets")
}

model MaintenanceRecord {
  id              Int                 @id @default(autoincrement())
  assetId         Int                 @map("asset_id")
  serviceDate     DateTime            @map("service_date") @db.Date
  type            MaintenanceTypeEnum @default(preventive)
  provider        String?             @db.VarChar(255)
  cost            Decimal?            @db.Decimal(18, 2)
  description     String?
  nextServiceDate DateTime?           @map("next_service_date") @db.Date
  createdAt       DateTime            @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime            @updatedAt @map("updated_at") @db.Timestamptz(6)
  asset           Asset               @relation(fields: [assetId], references: [id], onDelete: Cascade)

  @@index([assetId])
  @@index([serviceDate])
  @@map("maintenance_records")
}

model AssetLog {
  id                Int      @id @default(autoincrement())
  assetId           Int      @map("asset_id")
  userId            Int?     @map("user_id")
  projectId         Int?     @map("project_id")
  action            String   @db.VarChar(20)
  fuelLevelAtAction Int?     @map("fuel_level_at_action") @db.SmallInt
  timestamp         DateTime @default(now()) @db.Timestamptz(6)
  asset             Asset    @relation(fields: [assetId], references: [id], onDelete: Cascade)
  project           Project? @relation(fields: [projectId], references: [id])
  user              User?    @relation(fields: [userId], references: [id])

  @@index([assetId])
  @@map("asset_logs")
}

model Requisition {
  id              Int                   @id @default(autoincrement())
  reqCode         String                @unique @map("req_code") @db.VarChar(50)
  projectId       Int                   @map("project_id")
  vendorName      String?               @map("vendor_name") @db.VarChar(255) // Replaces vendorId/relation
  totalAmount     Decimal               @map("total_amount") @db.Decimal(15, 2)
  status          RequisitionStatusEnum @default(pending)
  rejectionReason String?               @map("rejection_reason") @db.Text
  submittedBy     Int                   @map("submitted_by")
  reviewedBy      Int?                  @map("reviewed_by")
  reviewedAt      DateTime?             @map("reviewed_at")
  fraudCheck      Boolean               @default(false) @map("fraud_check")
  createdAt       DateTime              @default(now()) @map("created_at")
  updatedAt       DateTime              @updatedAt @map("updated_at")

  // Relations
  items        RequisitionItem[]
  project      Project           @relation(fields: [projectId], references: [id])
  reviewer     User?             @relation("RequisitionsReviewed", fields: [reviewedBy], references: [id])
  submitter    User              @relation("RequisitionsSubmitted", fields: [submittedBy], references: [id])
  transactions Transaction[]

  @@index([projectId])
  @@index([submittedBy])
  @@index([reqCode])
  @@map("requisitions")
}

model RequisitionItem {
  id            Int         @id @default(autoincrement())
  requisitionId Int         @map("requisition_id")
  itemName      String      @map("item_name") @db.VarChar(255)
  quantity      Int
  unitPrice     Decimal     @map("unit_price") @db.Decimal(18, 2)
  requisition   Requisition @relation(fields: [requisitionId], references: [id], onDelete: Cascade)

  @@map("requisition_items")
}

model Transaction {
  id            Int          @id @default(autoincrement())
  entryCode     String?      @unique @map("entry_code") @db.VarChar(20)
  requisitionId Int?         @map("requisition_id")
  projectId     Int?         @map("project_id")
  accountCode   String?      @map("account_code") @db.VarChar(20)
  description   String?
  debit         Decimal      @default(0) @db.Decimal(18, 2)
  credit        Decimal      @default(0) @db.Decimal(18, 2)
  createdBy     Int?         @map("created_by")
  createdAt     DateTime     @default(now()) @map("created_at") @db.Timestamptz(6)
  creator       User?        @relation(fields: [createdBy], references: [id])
  project       Project?     @relation(fields: [projectId], references: [id])
  requisition   Requisition? @relation(fields: [requisitionId], references: [id])

  @@index([projectId])
  @@map("transactions")
}

model DailyLog {
  id               Int                   @id @default(autoincrement())
  projectId        Int                   @map("project_id")
  submittedBy      Int?                  @map("submitted_by")
  logDate          DateTime              @map("log_date") @db.Date
  headcount        Int?
  weather          String?               @db.VarChar(50)
  narrative        String?
  expenseAmount    Decimal?              @map("expense_amount") @db.Decimal(18, 2)
  expenseCategory  String?               @map("expense_category") @db.VarChar(50)
  expenseReason    String?               @map("expense_reason")
  photos           Json?
  isSos            Boolean               @default(false) @map("is_sos")
  pmApproved       Boolean               @default(false) @map("pm_approved")
  pmApprovedAt     DateTime?             @map("pm_approved_at") @db.Timestamptz(6)
  createdAt        DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  rejection_reason String?
  status           daily_log_status_enum @default(pending)
  task_id          Int?
  project          Project               @relation(fields: [projectId], references: [id], onDelete: Cascade)
  submitter        User?                 @relation(fields: [submittedBy], references: [id])
  tasks            Task?                 @relation(fields: [task_id], references: [id])

  @@index([projectId, logDate])
  @@map("daily_logs")
}

model SafetyIncident {
  id              Int       @id @default(autoincrement())
  projectId       Int?      @map("project_id")
  reportedBy      Int?      @map("reported_by")
  incidentType    String?   @map("incident_type") @db.VarChar(50)
  siteArea        String?   @map("site_area") @db.VarChar(100)
  personsInvolved String?   @map("persons_involved")
  description     String?
  photoUrl        String?   @map("photo_url")
  status          String    @default("open") @db.VarChar(20)
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  project         Project?  @relation(fields: [projectId], references: [id])
  reporter        User?     @relation(fields: [reportedBy], references: [id])

  @@map("safety_incidents")
}

model AuditLog {
  id         Int      @id @default(autoincrement())
  userId     Int?     @map("user_id")
  userName   String?  @map("user_name") @db.VarChar(100)
  userRole   String?  @map("user_role") @db.VarChar(50)
  action     String   @db.VarChar(50)
  targetType String?  @map("target_type") @db.VarChar(50)
  targetId   Int?     @map("target_id")
  targetCode String?  @map("target_code") @db.VarChar(50)
  ipAddress  String?  @map("ip_address") @db.Inet
  details    Json?
  timestamp  DateTime @default(now()) @db.Timestamptz(6)
  user       User?    @relation(fields: [userId], references: [id])

  @@index([timestamp])
  @@index([userId])
  @@map("audit_logs")
}

model ProcurementRequest {
  id                Int                   @id @default(autoincrement())
  reqCode           String                @unique @map("req_code") @db.VarChar(20)
  vehicleName       String                @map("vehicle_name") @db.VarChar(255)
  estimatedCost     Decimal?              @map("estimated_cost") @db.Decimal(18, 2)
  justification     String?
  priority          String                @default("Standard") @db.VarChar(20)
  requestedBy       Int?                  @map("requested_by")
  pmComments        String?               @map("pm_comments")
  pmReviewedAt      DateTime?             @map("pm_reviewed_at") @db.Timestamptz(6)
  financeComments   String?               @map("finance_comments")
  financeReviewedAt DateTime?             @map("finance_reviewed_at") @db.Timestamptz(6)
  status            ProcurementStatusEnum @default(pending_pm)
  createdAt         DateTime              @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime              @updatedAt @map("updated_at") @db.Timestamptz(6)
  requester         User?                 @relation(fields: [requestedBy], references: [id])

  @@index([status])
  @@map("procurement_requests")
}

model WhistleblowerReport {
  id          Int      @id @default(autoincrement())
  isAnonymous Boolean  @default(true) @map("is_anonymous")
  reporterId  Int?     @map("reporter_id")
  category    String?  @db.VarChar(100)
  projectId   Int?     @map("project_id")
  evidence    String?
  documentUrl String?  @map("document_url")
  status      String   @default("submitted") @db.VarChar(20)
  assignedTo  Int?     @map("assigned_to")
  createdAt   DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  assignee    User?    @relation("AssignedTo", fields: [assignedTo], references: [id])
  project     Project? @relation(fields: [projectId], references: [id])
  reporter    User?    @relation("Reporter", fields: [reporterId], references: [id])

  @@map("whistleblower_reports")
}

model BudgetChangeRequest {
  id                Int       @id @default(autoincrement())
  bcrCode           String    @unique @map("bcr_code") @db.VarChar(20)
  projectId         Int       @map("project_id")
  budgetCategory    String?   @map("budget_category") @db.VarChar(50)
  currentAmount     Decimal?  @map("current_amount") @db.Decimal(18, 2)
  proposedAmount    Decimal?  @map("proposed_amount") @db.Decimal(18, 2)
  justification     String?
  requestedBy       Int?      @map("requested_by")
  status            String    @default("pending") @db.VarChar(20)
  pmApproved        Boolean?  @map("pm_approved")
  pmApprovedAt      DateTime? @map("pm_approved_at") @db.Timestamptz(6)
  financeApproved   Boolean?  @map("finance_approved")
  financeApprovedAt DateTime? @map("finance_approved_at") @db.Timestamptz(6)
  createdAt         DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  project           Project   @relation(fields: [projectId], references: [id], onDelete: Cascade)
  requester         User?     @relation(fields: [requestedBy], references: [id])

  @@map("budget_change_requests")
}

model Issue {
  id              Int       @id @default(autoincrement())
  issueCode       String    @unique @map("issue_code") @db.VarChar(20)
  category        String?   @db.VarChar(100)
  projectId       Int?      @map("project_id")
  siteLocation    String?   @map("site_location") @db.VarChar(100)
  priority        String    @default("Medium") @db.VarChar(20)
  description     String?
  photoUrl        String?   @map("photo_url")
  reportedBy      Int?      @map("reported_by")
  assignedTo      Int?      @map("assigned_to")
  status          String    @default("open") @db.VarChar(20)
  resolutionNotes String?   @map("resolution_notes")
  resolvedAt      DateTime? @map("resolved_at") @db.Timestamptz(6)
  createdAt       DateTime  @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt       DateTime  @updatedAt @map("updated_at") @db.Timestamptz(6)
  assignee        User?     @relation("AssignedTo", fields: [assignedTo], references: [id])
  project         Project?  @relation(fields: [projectId], references: [id])
  reporter        User?     @relation("ReportedBy", fields: [reportedBy], references: [id])

  @@index([projectId])
  @@index([status])
  @@map("issues")
}

enum RoleEnum {
  Project_Manager        @map("Project Manager")
  Finance_Director       @map("Finance Director")
  Field_Supervisor       @map("Field Supervisor")
  Contract_Administrator @map("Contract Administrator")
  Equipment_Coordinator  @map("Equipment Coordinator")
  Operations_Manager     @map("Operations Manager")
  Managing_Director      @map("Managing Director")
  System_Technician      @map("System Technician")

  @@map("role_enum")
}

enum ProjectStatusEnum {
  active
  planning
  on_hold
  completed
  cancelled

  @@map("project_status_enum")
}

enum ContractStatusEnum {
  active
  draft
  expired
  cancelled

  @@map("contract_status_enum")
}

enum MilestoneStatusEnum {
  scheduled
  pending
  certified
  paid

  @@map("milestone_status_enum")
}

model Document {
  id                Int      @id @default(autoincrement())
  title             String   @db.VarChar(255)
  description       String?
  originalName      String   @map("original_name") @db.VarChar(255)
  currentVersionUrl String   @map("current_version_url")
  status            String   @default("active") @db.VarChar(20)
  projectId         Int      @map("project_id")
  uploadedById      Int      @map("uploaded_by_id")
  createdAt         DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt         DateTime @updatedAt @map("updated_at") @db.Timestamptz(6)

  project    Project           @relation(fields: [projectId], references: [id], onDelete: Cascade)
  uploadedBy User              @relation("DocumentUploader", fields: [uploadedById], references: [id])
  versions   DocumentVersion[]

  @@index([projectId])
  @@map("documents")
}

model DocumentVersion {
  id            Int      @id @default(autoincrement())
  documentId    Int      @map("document_id")
  versionNumber Int      @map("version_number")
  fileUrl       String   @map("file_url")
  changeNotes   String?  @map("change_notes")
  uploadedById  Int      @map("uploaded_by_id")
  createdAt     DateTime @default(now()) @map("created_at") @db.Timestamptz(6)

  document   Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  uploadedBy User     @relation("DocumentVersionUploader", fields: [uploadedById], references: [id])

  @@index([documentId])
  @@map("document_versions")
}

// Vendor model removed

enum AssetConditionEnum {
  Good
  Fair
  Poor

  @@map("asset_condition_enum")
}

enum AssetStatusEnum {
  available
  checked_out
  in_transit
  maintenance
  decommissioned

  @@map("asset_status_enum")
}

enum RequisitionStatusEnum {
  pending
  approved
  rejected
  fraud_flag

  @@map("requisition_status_enum")
}

enum ProcurementStatusEnum {
  pending_pm
  pending_finance
  approved
  rejected
  purchased

  @@map("procurement_status_enum")
}

enum daily_log_status_enum {
  pending
  approved
  rejected
}

enum ProjectTypeEnum {
  civil_works         @map("Civil Works")
  bridge_construction @map("Bridge Construction")
  road_works          @map("Road Works")
  building_works      @map("Building Works")

  @@map("project_type_enum")
}

enum MaintenanceTypeEnum {
  preventive
  corrective
  emergency

  @@map("maintenance_type_enum")
}
